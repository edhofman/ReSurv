---
title: "Vignette Title"
author: "Vignette Author"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Deep surv}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(ReSurv)

```

```{r}
# Input data

input_data <- data_generator(random_seed = 12,
                              scenario=2,
                              time_unit = 1/360,
                              years = 4,
                              yearly_exposure = 200)

```

# Without calendar component (same as before, notice new inputs)

```{r}
# # # ## Model fit ----
  individual_data <- IndividualData(data = input_data,
                                    id=NULL,
                                    categorical_features = c("claim_type"),
                                    continuous_features = "AP_i",
                                    accident_period="AP",
                                    calendar_period="RP",
                                    input_time_granularity = "days",
                                    output_time_granularity = "quarters",
                                    years=4 #check this. I see strange development periods
  )
  

```

```{r}
# Model fit ----
resurv.fit.cox <- ReSurv(individual_data,
                          hazard_model = "cox")

```

```{r}

# # # ## Model fit ----
s1 <- Sys.time()
resurv.fit.xgb <- ReSurv(individual_data,
                         hazard_model = "xgboost",
                         hparameters = list(params=list(booster="gbtree",
                                             eta=.01,
                                             subsample=.5,
                                             alpha=1,
                                             lambda=1,
                                             min_child_weight=.2),
                                             print_every_n = 1,
                                             nrounds=10,
                                             verbose=F,
                                             early_stopping_rounds = 500))
e1 <- Sys.time()
e1-s1
```



```{r}
# Model fit ----
resurv.fit.LTRCtrees <- ReSurv(individual_data,
                               hazard_model = "LTRCtrees")

```

```{r}
s1 <- Sys.time()
resurv.fit.deepsurv <- ReSurv(individual_data,
                              hazard_model = "deepsurv",
                              hparameters=list(num_layers=c(10),
                                              early_stopping = TRUE,
                                              patience = 50,
                                              verbose=T,
                                              network_structure = NULL,
                                              num_nodes = c(10),
                                              activation = "LeakyReLU",
                                              optim="Adam",
                                              lr = 0.005,
                                              xi=0.480269023349308,
                                              epsilon = 0,
                                              batch_size=as.integer(5000),
                                              epochs=as.integer(2),
                                              num_workers=0,
                                              tie='Efron'))

e1 <- Sys.time()
# Time difference of 8.310856 mins

```



```{r}

#Plot different development factors

resurv.cox.predictions <- predict(resurv.fit.cox,grouping_method="probability")
resurv.deepsurv.predictions <- predict(resurv.fit.deepsurv,grouping_method="probability")
resurv.LTRCtrees.predictions <- predict(resurv.fit.LTRCtrees,grouping_method="probability")
resurv.xgb.predictions <- predict(resurv.fit.xgb,grouping_method="probability")

df_output_combined <- bind_rows(
  resurv.cox.predictions$df_output %>%
    reshape2::melt(id.vars="DP_o") %>% 
    mutate(Model="Cox"),
    resurv.deepsurv.predictions$df_output %>% reshape2::melt(id.vars="DP_o") %>% 
    mutate(Model="DeepSurv"),
    resurv.LTRCtrees.predictions$df_output %>% reshape2::melt(id.vars="DP_o") %>% 
    mutate(Model="LTRCTrees"),
    resurv.xgb.predictions$df_output %>% reshape2::melt(id.vars="DP_o") %>% 
    mutate(Model="XgBoost"),
) %>% rowwise() %>% 
  mutate(
    AP_o =  substr(variable,
                     unlist(gregexpr('_', variable))[2] +1,
                     unlist(gregexpr('\\,', variable))[1]-1 ),
    claim_type = substr(variable, nchar(as.character(variable)), nchar(as.character(variable)))
  ) %>% 
  ungroup() %>% 
  mutate(relevant=ifelse(AP_o==10, 1,0)) %>% 
  arrange(desc(relevant)) %>% 
  mutate(col=paste0(Model,AP_o))

p <- ggplot(data=df_output_combined) + geom_line(aes(x=DP_o, y=value, colour=col, linetype=claim_type)) +
  scale_linetype_manual(name = "Claim type", values=c(1,2), labels = c("Claim type 0","Claim type 1" ))+ 
  scale_colour_manual( values=c(
    c("red","green","blue","yellow"),
    c(rep("grey",60))
    ),
    guide="none"
    )+
  ggtitle("Simulation 2 development factor comparison") +
  xlab("Quarterly development period") + ylab("Development factor")+
  theme_bw()
  
p


```



# Standard code

```{r eval=FALSE, include=FALSE}

# # # ## Model fit ----

resurv.cv.xgboost <- ReSurvCV(IndividualData=individual_data,
                               model="xgboost",
                               hparameters_grid=list(booster="gbtree",
                                             eta=c(.001,.01,.2,.3),
                                             max_depth=c(3,6,8),
                                             subsample=c(1),
                                             alpha=c(0,.2,1),
                                             lambda=c(0,.2,1),
                                             min_child_weight=c(.5,1)),
                               print_every_n = 1L,
                               nrounds=500,
                               verbose=F,
                               verbose.cv=T,
                               early_stopping_rounds = 100,
                               folds=5,
                               parallel=T,
                               ncores=2,
                               random_seed=1)

```


```{r}
# # # ## Model fit ----
#With parallel computing

resurv.cv.deep_surv_par <- ReSurvCV(IndividualData=individual_data,
                               model="deepsurv",
                               hparameters_grid=list(num_layers = c(10L),
                                                      num_nodes = c(10L),
                                                      optim=c("Adam"),
                                                      activation = "LeakyReLU",
                                                      lr=c(0.005),
                                                      xi=c(0.480269023349308),
                                                      eps = c(00),
                                                      tie = "Efron",
                                                      batch_size = c(as.integer(5000)),
                                                      early_stopping = 'TRUE',
                                                      patience  = 20
                                ),
                              epochs = as.integer(2),
                              num_workers = 0,
                              parallel = F,
                              ncores = 1,
                              verbose = T,
                              folds=2,
                              random_seed=1)





```


```{r}
# # # ## Model fit ----
# library(reticulate)
resurv.fit.deep_surv <- ReSurv(individual_data,
                          hazard_model = "deepsurv",
                          hparameters=list(num_layers=c(4),
                                          early_stopping = FALSE,
                                          patience = 20,
                                          network_structure = NULL,
                                          num_nodes = c(10),
                                          activation = "LeakyReLU",
                                          optim="Adam",
                                          lr = 0.005,
                                          xi=1,
                                          epsilon = 0,
                                          batch_size=as.integer(1000),
                                          epochs=as.integer(10),
                                          num_workers=0,
                                          tie="Efron"))



```



```{r}
# # # ## Model fit ----
resurv.fit.cox <- ReSurv(individual_data,
                          hazard_model = "cox")

```

```{r}
# # # ## Model fit ----
resurv.fit.xgboost <- ReSurv(individual_data,
                          hazard_model = "xgboost",
                          hparameters = list(params=list(booster="gbtree",
                                             eta=.01,
                                             subsample=.5,
                                             alpha=1,
                                             lambda=1,
                                             min_child_weight=.2),
                                             print_every_n = 1,
                                             nrounds=10,
                                             verbose=F,
                                             early_stopping_rounds = 500))

```


```{r}
# # # ## Model fit ----
resurv.fit.ltrctrees <- ReSurv(individual_data,
                               hazard_model = "LTRCtrees")

```
```{r eval=FALSE, include=FALSE}

# # # ## Model fit ----
resurv.cv.ltrctrees <- ReSurvCV(IndividualData=individual_data,
                               model="LTRCtrees",
                               hparameters_grid = list(
                                 minbucket = c(1,2),
                                 cp=c(.2,.01)),
                               folds=5,
                               random_seed=1,
                               verbose.cv = T)

```


```{r eval=FALSE, include=FALSE}

plot_data <-resurv.fit.deep_surv$hazard_frame_input %>% 
  select(AP_i, claim_type, DP_rev_i, df_i) %>% 
  distinct() 

ggplot(plot_data) +
  geom_point( aes(x=DP_rev_i, y=df_i, col=AP_i)) +
  facet_wrap(~claim_type, scales="free") +
  scale_colour_gradient(name="Accident period") +
  theme_bw() +
  scale_x_continuous(trans="reverse",
                     limits=c(48,40),
                     breaks = c(seq(from=48,to=40,by=-1)),
                     labels=c(seq(1,9,1))) +
  ggtitle("Accident period dependent development factors")+
  xlab("Development Period") +
  ylab("Development Factor")
  

```

```{r eval=FALSE, include=FALSE}

  
  
  #Score on output granuality
  individual_data <- IndividualData(input_data,
                                  id="claim_number",
                                  continuous_features="AP_i",
                                  categorical_features="claim_type",
                                  accident_period="AM",
                                  calendar_period="RM",
                                  input_time_granularity = "months",
                                  output_time_granularity = "quarters",
                                  years=4,
                                  continuous_features_spline=NULL)
  
resurv.fit <- ReSurv(individual_data,
                          hazard_model = "deepsurv",
                          hparameters=list(num_layers=c(4),
                                          early_stopping = FALSE,
                                          patience = 20,
                                          network_structure = NULL,
                                          num_nodes = c(10),
                                          activation = "LeakyReLU",
                                          optim="Adam",
                                          lr = 0.005,
                                          xi=1,
                                          epsilon = 0,
                                          batch_size=as.integer(1000),
                                          epochs=as.integer(10),
                                          num_workers=0,
                                          tie="Efron"))
  
resurv.fit <- 

  
  
conversion_factor <- resurv.fit$IndividualData$conversion_factor

  true_output <- resurv.fit$IndividualData$full.data %>%
    filter(DP_rev_i <= TR_i) %>%
    mutate(
      DP_rev_o = floor(max(DP_i)*conversion_factor)-ceiling(DP_i*conversion_factor+((AP_i-1)%%(1/conversion_factor))*conversion_factor) +1,
      AP_o = ceiling(AP_i*conversion_factor)
    ) %>%
    group_by(claim_type, AP_o, DP_rev_o) %>%
    mutate(claim_type = as.character(claim_type)) %>%
    summarize(I=sum(I), .groups = "drop")

  score_data <- resurv.fit$hazard_frame_output[,c("claim_type","AP_o", "DP_rev_o", "I_expected")] %>%
    inner_join(true_output, by =c("claim_type","AP_o", "DP_rev_o")) %>%
    mutate(ave = I-I_expected,
           abs_ave = abs(ave))
  

  sum(score_data$ave)
  sum(score_data$abs_ave)
  
  #chain ladder
  CL = resurv.fit$IndividualData$training.data %>% 
    mutate(DP_o = max(resurv.fit$hazard_frame_output$DP_rev_o)-DP_rev_o + 1) %>% 
    group_by(AP_o, DP_o) %>% 
    summarize(I=sum(I), .groups="drop") %>%  
    group_by(AP_o) %>%
    arrange(DP_o) %>% 
    mutate(I_cum = cumsum(I),
           I_cum_lag = lag(I_cum, default=0)) %>% 
    ungroup() %>% 
    group_by(DP_o) %>% 
    reframe(df = sum(I_cum*(AP_o<=max(resurv.fit$IndividualData$training.data$AP_o)-DP_o+1)) /
            sum(I_cum_lag*(AP_o<=max(resurv.fit$IndividualData$training.data$AP_o)-DP_o+1)),
              I=sum(I*(AP_o<=max(resurv.fit$IndividualData$training.data$AP_o)-DP_o))) %>% 
    mutate(DP_o_join = DP_o-1)
  
  latest_observed <- resurv.fit$IndividualData$training.data %>% 
    mutate(DP_o = max(resurv.fit$hazard_frame_output$DP_rev_o)-DP_rev_o + 1) %>% 
    group_by(AP_o) %>% 
    mutate(DP_max =max(DP_o)) %>% 
    group_by(AP_o, DP_max) %>% 
    summarize(I=sum(I),.groups="drop")
    
  predictions <- expand.grid(AP_o = latest_observed$AP_o, DP_o = CL$DP_o_join) %>% 
    left_join(CL[,c("DP_o_join", "df")], by=c("DP_o"="DP_o_join")) %>% 
    left_join(latest_observed, by="AP_o") %>% 
    group_by(AP_o) %>% 
    filter(DP_o>=DP_max) %>% 
    arrange(DP_o) %>% 
    mutate(df_cum = cumprod(df) ) %>% 
    mutate(I_expected= I*df_cum-I*lag(df_cum,default=1)) %>% 
    mutate(DP_o = DP_o +1) %>% 
    select(DP_o, AP_o, I_expected)
  
  
  true_output_cl <- true_output %>%
                 mutate(DP_o = max(resurv.fit$hazard_frame_output$DP_rev_o)-DP_rev_o + 1) %>% 
    group_by(AP_o, DP_o) %>% 
    summarize(I=sum(I), .groups="drop")
   
  score_data_CL <- predictions  %>%
    inner_join(true_output_cl,
               by =c("AP_o", "DP_o")) %>%
    mutate(ave = I-I_expected,
           abs_ave = abs(ave))
  
  sum(score_data_CL$ave)
  sum(score_data_CL$abs_ave)

```








