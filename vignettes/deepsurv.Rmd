---
title: "Vignette Title"
author: "Vignette Author"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Deep surv}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(ReSurv)

```

```{r}
# Input data

input_data <- data_generator(random_seed = 1964)

```


```{r}
# # # ## Model fit ----
individual_data <- IndividualData(input_data,
                                  id="claim_number",
                                  continuous_features=NULL,
                                  categorical_features="claim_type",
                                  accident_period="AM",
                                  calendar_period="RM",
                                  input_time_unit=1/12,
                                  output_time_unit=1/4,
                                  years=4,
                                  continuous_features_spline=F,
                                  degrees_of_freedom=4)

```


```{r eval=FALSE, include=FALSE}

# # # ## Model fit ----

resurv.cv.xgboost <- ReSurvCV(IndividualData=individual_data,
                               model="xgboost",
                               hparameters_grid=list(booster="gbtree",
                                             eta=c(.01,.1),
                                             subsample=.5,
                                             alpha=1,
                                             lambda=1,
                                             min_child_weight=.2),
                               print_every_n = NULL,
                               nrounds=10,
                               verbose=F,
                               verbose.cv=T,
                               early_stopping_rounds = 10,
                               folds=5,
                               random_seed=1)

```


```{r}
# # # ## Model fit ----
library(reticulate)
start <- Sys.time()
resurv.cv.deep_surv <- ReSurvCV(IndividualData=individual_data,
                               model="deepsurv",
                               hparameters_grid=list(num_layers = c(2L,5L,10L),
                                                    num_nodes = c(2,10,25),
                                                    optim=c("Adam", "SGD"),
                                                    activation = "LeakyReLU",
                                                    lr=c(.1,.02,.005),
                                                    xi=c(0,.01,.1),
                                                    eps = c(0,.05,0.2),
                                                    tie = "Efron",
                                                    batch_size = c(as.integer(500), 
                                                                   as.integer(1000),
                                                                   as.integer(5000)),
                                                    early_stopping = 'TRUE',
                                                    patience  = 20
                                                    ),
                              epochs = as.integer(150),
                              num_workers = 0,
                              verbose = F,
                              folds=5,
                              random_seed=1)
end <- Sys.time()



```


```{r}
# # # ## Model fit ----
library(reticulate)
resurv.fit.deep_surv <- ReSurv(individual_data,
                          hazard_model = "deepsurv",
                          hparameters=list(num_layers=c(2),
                                          early_stopping = FALSE,
                                          patience = 20,
                                          network_structure = NULL,
                                          num_nodes = c(10,10),
                                          activation = "LeakyReLU",
                                          optim="Adam",
                                          lr = 0.005,
                                          xi=1,
                                          epsilon = 0,
                                          batch_size=as.integer(1000),
                                          epochs=as.integer(10),
                                          num_workers=0,
                                          tie="Efron"))



```

```{r eval=FALSE, include=FALSE}

print(head(resurv.fit$hazard_frame_input))

```


```{r}
# # # ## Model fit ----
resurv.fit.cox <- ReSurv(individual_data,
                          hazard_model = "cox")

```

```{r}
# # # ## Model fit ----
resurv.fit.xgboost <- ReSurv(individual_data,
                          hazard_model = "xgboost",
                          hparameters = list(params=list(booster="gbtree",
                                             eta=.01,
                                             subsample=.5,
                                             alpha=1,
                                             lambda=1,
                                             min_child_weight=.2),
                                             print_every_n = 1,
                                             nrounds=10,
                                             early_stopping_rounds = 500))

```


```{r}
# # # ## Model fit ----
resurv.fit.ltrctrees <- ReSurv(individual_data,
                               hazard_model = "LTRCtrees")

```
```{r eval=FALSE, include=FALSE}

# # # ## Model fit ----
resurv.cv.ltrctrees <- ReSurvCV(IndividualData=individual_data,
                               model="LTRCtrees",
                               hparameters_grid = list(
                                 minbucket = c(1,2),
                                 cp=c(.2,.01)),
                               folds=5,
                               random_seed=1,
                               verbose.cv = T)

```


```{r eval=FALSE, include=FALSE}
library(fastDummies)

hparameters=list(num_nodes=c(10,10),
    early_stopping = FALSE,
    patience = 20,
    network_structure = NULL,
    num_nodes = c(10,10),
    activation = "LeakyReLU",
    lr = 0.005,
    xi=1,
    epsilon = 0,
    batch_size=as.integer(1000),
    epochs=as.integer(100),
    num_workers=0,
    tie="Efron")

X <- pkg.env$model.matrix.creator(data= individual_data$training.data,
                                      select_columns = individual_data$categorical_features)

    scaler <- pkg.env$scaler(continuous_features_scaling_method='minmax')

    Xc <- individual_data$training.data %>%
      summarize(across(all_of(individual_data$continuous_features),
                       scaler))

    training_test_split = pkg.env$check.traintestsplit(.8)

    datads_pp = pkg.env$deep_surv_pp(X=cbind(X,Xc),
                           Y=individual_data$training.data[,c("DP_rev_i", "I", "TR_i")],
                           training_test_split = training_test_split)

    
    
    
    model.out <- pkg.env$fit_deep_surv(datads_pp,
                                       hparameters=hparameters)



    bsln <- model.out$compute_baseline_hazards(
      input = datads_pp$x_train,
      target = datads_pp$y_train,
      batch_size = hparameters$batch_size)


    newdata.mx <- pkg.env$df.2.fcst.nn.pp(data=individual_data$training.data,
                                          newdata=newdata,
                                          continuous_features=individual_data$continuous_features,
                                          categorical_features=individual_data$categorical_features)

    x_fc= reticulate::np_array(as.matrix(newdata.mx), dtype = "float32")

    beta_ams <- model.out$predict(input=x_fc,
                            batch_size=hparameters$batch_size,
                            num_workers=hparameters$num_workers)

    # X_ams <- cbind(X_i, Xb)
    #
    # beta_ams = unique(round(X_ams,10) )[,ncol(X_ams)] #if no round some systems has too high precision.
    #
    expg <- exp(beta_ams)
    
    hazard_frame <- cbind(newdata,expg)
    bsln <- data.frame(baseline=bsln, DP_rev_i=as.integer(names(bsln)))
    
    hazard_frame <- hazard_frame %>%
      full_join(bsln,
                by="DP_rev_i") %>%
      as.data.frame()
    
     hazard_frame[,'hazard'] <- hazard_frame[,'baseline']*hazard_frame[,'expg']

    
    # l = length(beta_ams)

```










