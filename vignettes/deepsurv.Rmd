---
title: "Vignette Title"
author: "Vignette Author"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Deep surv}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(ReSurv)

```

```{r}
# Input data

input_data <- data_generator(random_seed = 1964,
                             scenario=2)

```

# Without calendar component (same as before, notice new inputs)

```{r}
# # # ## Model fit ----
individual_data <- IndividualData(input_data,
                                  id="claim_number",
                                  continuous_features="AP_i",
                                  categorical_features="claim_type",
                                  accident_period="AM",
                                  calendar_period="RM",
                                  input_time_granularity = "months",
                                  output_time_granularity = "quarters",
                                  years=4,
                                  continuous_features_spline=NULL,
                                  calendar_period_extrapolation=F)

```

```{r}
# # # ## Model fit ----
resurv.fit.cox <- ReSurv(individual_data,
                          hazard_model = "cox")

```

# With calendar component

```{r}
# # # ## Model fit ----
individual_data <- IndividualData(input_data,
                                  id="claim_number",
                                  continuous_features=NULL,
                                  categorical_features="claim_type",
                                  accident_period="AM",
                                  calendar_period="RM",
                                  input_time_granularity = "months",
                                  output_time_granularity = "quarters",
                                  years=4,
                                  continuous_features_spline=NULL,
                                  calendar_period_extrapolation=T)

```

```{r}
# # # ## Model fit ----
resurv.fit.cox <- ReSurv(individual_data,
                          hazard_model = "cox")

```

# Standard code

```{r eval=FALSE, include=FALSE}

# # # ## Model fit ----

resurv.cv.xgboost <- ReSurvCV(IndividualData=individual_data,
                               model="xgboost",
                               hparameters_grid=list(booster="gbtree",
                                             eta=c(.001,.01,.2,.3),
                                             max_depth=c(3,6,8),
                                             subsample=c(1),
                                             alpha=c(0,.2,1),
                                             lambda=c(0,.2,1),
                                             min_child_weight=c(.5,1)),
                               print_every_n = 1L,
                               nrounds=500,
                               verbose=F,
                               verbose.cv=T,
                               early_stopping_rounds = 100,
                               folds=5,
                               parallel=T,
                               ncores=2,
                               random_seed=1)

```


```{r}
# # # ## Model fit ----
#With parallel computing

resurv.cv.deep_surv_par <- ReSurvCV(IndividualData=individual_data,
                               model="deepsurv",
                               hparameters_grid=list(num_layers = c(2L,3L),
                                                      num_nodes = c(2),
                                                      optim=c("Adam"),
                                                      activation = "LeakyReLU",
                                                      lr=c(0.01),
                                                      xi=c(0),
                                                      eps = c(0.2),
                                                      tie = "Efron",
                                                      batch_size = c(as.integer(1000)),
                                                      early_stopping = 'TRUE',
                                                      patience  = 20
                                ),
                              epochs = as.integer(2),
                              num_workers = 0,
                              parallel = T,
                              ncores = 2,
                              verbose = F,
                              folds=2,
                              random_seed=1)





```


```{r}
# # # ## Model fit ----
# library(reticulate)
resurv.fit.deep_surv <- ReSurv(individual_data,
                          hazard_model = "deepsurv",
                          hparameters=list(num_layers=c(4),
                                          early_stopping = FALSE,
                                          patience = 20,
                                          network_structure = NULL,
                                          num_nodes = c(10),
                                          activation = "LeakyReLU",
                                          optim="Adam",
                                          lr = 0.005,
                                          xi=1,
                                          epsilon = 0,
                                          batch_size=as.integer(1000),
                                          epochs=as.integer(10),
                                          num_workers=0,
                                          tie="Efron"))



```



```{r}
# # # ## Model fit ----
resurv.fit.cox <- ReSurv(individual_data,
                          hazard_model = "cox")

```

```{r}
# # # ## Model fit ----
resurv.fit.xgboost <- ReSurv(individual_data,
                          hazard_model = "xgboost",
                          hparameters = list(params=list(booster="gbtree",
                                             eta=.01,
                                             subsample=.5,
                                             alpha=1,
                                             lambda=1,
                                             min_child_weight=.2),
                                             print_every_n = 1,
                                             nrounds=10,
                                             verbose=F,
                                             early_stopping_rounds = 500))

```


```{r}
# # # ## Model fit ----
resurv.fit.ltrctrees <- ReSurv(individual_data,
                               hazard_model = "LTRCtrees")

```
```{r eval=FALSE, include=FALSE}

# # # ## Model fit ----
resurv.cv.ltrctrees <- ReSurvCV(IndividualData=individual_data,
                               model="LTRCtrees",
                               hparameters_grid = list(
                                 minbucket = c(1,2),
                                 cp=c(.2,.01)),
                               folds=5,
                               random_seed=1,
                               verbose.cv = T)

```


```{r eval=FALSE, include=FALSE}

plot_data <-resurv.fit.deep_surv$hazard_frame_input %>% 
  select(AP_i, claim_type, DP_rev_i, df_i) %>% 
  distinct() 

ggplot(plot_data) +
  geom_point( aes(x=DP_rev_i, y=df_i, col=AP_i)) +
  facet_wrap(~claim_type, scales="free") +
  scale_colour_gradient(name="Accident period") +
  theme_bw() +
  scale_x_continuous(trans="reverse",
                     limits=c(48,40),
                     breaks = c(seq(from=48,to=40,by=-1)),
                     labels=c(seq(1,9,1))) +
  ggtitle("Accident period dependent development factors")+
  xlab("Development Period") +
  ylab("Development Factor")
  

```










